<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            text-align: center;
        }
        .main-container {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        .form-container {
            flex: 1;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .tables-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .filter-container {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        .table-wrapper {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        label {
            display: block;
            margin-bottom: 8px;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: middle;
        }
        th {
            background-color: #f2f2f2;
        }
        .preview-container img {
            max-width: 100px;
            max-height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }
        .action-buttons button {
            margin-right: 5px;
            padding: 5px 10px;
        }
        .action-buttons .edit-btn { background-color: #007bff; }
        .action-buttons .delete-btn { background-color: #dc3545; }
        .action-buttons .config-btn { background-color: #ffc107; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
        <h1>Panel de Administración</h1>
        <a href="gestion.html" style="text-decoration: none; background-color: #007bff; color: white; padding: 10px 15px; border-radius: 4px; font-size: 16px;">Gestionar Relaciones</a>
    </div>

    <div class="main-container">
        <div class="form-container">
            <h2 id="form-title">Registrar Nuevo Item</h2>
            <form id="itemForm">
                <label for="itemType">Tipo:</label>
                <select id="itemType" required>
                    <option value="corte">Corte de Pelo</option>
                    <option value="barba">Barba</option>
                </select>

                <label for="itemName">Nombre:</label>
                <input type="text" id="itemName" required>

                <label for="itemDescription">Descripción:</label>
                <textarea id="itemDescription" rows="3" required></textarea>

                <label for="itemPrice">Precio:</label>
                <input type="number" id="itemPrice" step="1" required>

                <label for="itemImage">Imagen (opcional si editas):</label>
                <input type="file" id="itemImage" accept="image/*">

                <div class="preview-container">
                    <p>Previsualización de la imagen:</p>
                    <img id="imagePreview" src="#" alt="Previsualización">
                </div>

                <button type="submit">Guardar</button>
            </form>
        </div>

        <div class="tables-container">
            <div class="filter-container">
                <label><input type="radio" name="tableFilter" value="cortes" checked> Mostrar Cortes</label>
                <label><input type="radio" name="tableFilter" value="barbas"> Mostrar Barbas</label>
            </div>

            <div id="cortesTable" class="table-wrapper">
                <h2>Tabla de Cortes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Rol</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Imagen</th>
                            <th>Destacado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cortesTableBody">
                        <!-- Las filas se insertarán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>

            <div id="barbasTable" class="table-wrapper hidden">
                <h2>Tabla de Barbas</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Rol</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Imagen</th>
                            <th>Destacado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="barbasTableBody">
                        <!-- Contenido de la tabla de barbas -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Configurar Item</h2>
            <form id="configForm">
                <label><input type="radio" name="configOption" value="destacado"> Agregar a Destacado</label>
                <label><input type="radio" name="configOption" value="principal" checked> Designar como Principal</label>
                
                <div id="destacadoOptions" class="hidden">
                    <label for="destacadoImagePreview">Imagen Actual:</label>
                    <img id="destacadoImagePreview" src="#" alt="Imagen destacado actual" style="max-width: 150px; display: none; margin-bottom: 10px; border-radius: 4px;">
                    
                    <label for="destacadoImage">Subir/Cambiar Imagen Destacado:</label>
                    <input type="file" id="destacadoImage" accept="image/*">
                    
                    <div class="preview-container">
                        <p>Previsualización de nueva imagen:</p>
                        <img id="destacadoImageNewPreview" src="#" alt="Previsualización" style="max-width: 150px;">
                    </div>
                    
                    <label for="destacadoDescription">Descripción para Destacado:</label>
                    <textarea id="destacadoDescription" rows="3" placeholder="Escribe una descripción corta y llamativa..."></textarea>
                    <small style="color: #666;">Si el corte es principal, se prellenará con su descripción principal</small>
                </div>

                <div id="principalOptions">
                    <label for="principalDescription">Descripción Principal (palabras clave, gancho):</label>
                    <textarea id="principalDescription" rows="4"></textarea>
                </div>
                <button type="submit">Guardar Configuración</button>
            </form>
        </div>
    </div>

    <script>
        const itemForm = document.getElementById('itemForm');
        const imageInput = document.getElementById('itemImage');
        const imagePreview = document.getElementById('imagePreview');
        const cortesTableBody = document.getElementById('cortesTableBody');
        const formButton = itemForm.querySelector('button[type="submit"]');
        let editingId = null;
        let allCortes = []; // Caché para los datos de los cortes
        let currentConfigId = null; // ID del corte/barba que se está configurando
        let currentConfigType = 'corte'; // 'corte' o 'barba'

        // --- MODAL ELEMENTS ---
        const modal = document.getElementById('configModal');
        const closeModalBtn = modal.querySelector('.close-button');
        const configForm = document.getElementById('configForm');
        const destacadoOptions = document.getElementById('destacadoOptions');
        const principalOptions = document.getElementById('principalOptions');

        document.addEventListener('DOMContentLoaded', () => {
            loadCortes();
            loadBarbas();
        });

        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                imagePreview.src = '#';
                imagePreview.style.display = 'none';
            }
        });

        // Preview para imagen destacado
        const destacadoImageInput = document.getElementById('destacadoImage');
        const destacadoImageNewPreview = document.getElementById('destacadoImageNewPreview');
        
        destacadoImageInput.addEventListener('change', () => {
            const file = destacadoImageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    destacadoImageNewPreview.src = e.target.result;
                    destacadoImageNewPreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                destacadoImageNewPreview.src = '#';
                destacadoImageNewPreview.style.display = 'none';
            }
        });

        async function loadCortes() {
            try {
                const response = await fetch('/api/cortes_admin');
                if (!response.ok) throw new Error('Error al cargar los cortes');
                allCortes = await response.json(); // Guardar en caché

                cortesTableBody.innerHTML = '';
                allCortes.forEach(corte => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${corte.id}</td>
                        <td>${corte.nombre}</td>
                        <td>${corte.rol || 'No asignado'}</td>
                        <td style="max-width: 300px; white-space: normal;">${corte.descripcion}</td>
                        <td>${formatPrice(corte.precio)}</td>
                        <td><img src="${corte.imagen}" alt="${corte.nombre}" style="width: 50px; height: 50px;"></td>
                        <td>${corte.destacado ? 'Sí' : 'No'}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" onclick="editItem(${corte.id})">Editar</button>
                            <button class="delete-btn" onclick="deleteItem(${corte.id})">Eliminar</button>
                            <button class="config-btn" onclick="openConfigModal(${corte.id})">Configurar</button>
                            <button style="background-color: #17a2b8; color: white;" onclick="moverABarbas(${corte.id})">Mover a Barbas</button>
                        </td>
                    `;
                    cortesTableBody.appendChild(tr);
                });
            } catch (error) {
                console.error(error);
                alert('No se pudieron cargar los cortes.');
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(price);
        }

        async function loadBarbas() {
            try {
                const response = await fetch('/api/barbas_admin');
                if (!response.ok) throw new Error('Error al cargar las barbas');
                const allBarbas = await response.json();

                const barbasTableBody = document.getElementById('barbasTableBody');
                barbasTableBody.innerHTML = '';
                allBarbas.forEach(barba => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${barba.id}</td>
                        <td>${barba.nombre}</td>
                        <td>${barba.rol || 'No asignado'}</td>
                        <td style="max-width: 300px; white-space: normal;">${barba.descripcion}</td>
                        <td>${formatPrice(barba.precio)}</td>
                        <td><img src="${barba.imagen}" alt="${barba.nombre}" style="width: 50px; height: 50px;"></td>
                        <td>${barba.destacado ? 'Sí' : 'No'}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" onclick="editBarba(${barba.id})">Editar</button>
                            <button class="delete-btn" onclick="deleteBarba(${barba.id})">Eliminar</button>
                            <button class="config-btn" onclick="openConfigModalBarba(${barba.id})">Configurar</button>
                            <button style="background-color: #17a2b8; color: white;" onclick="moverACortes(${barba.id})">Mover a Cortes</button>
                        </td>
                    `;
                    barbasTableBody.appendChild(tr);
                });
            } catch (error) {
                console.error(error);
                alert('No se pudieron cargar las barbas.');
            }
        }

        itemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('nombre', document.getElementById('itemName').value);
            formData.append('descripcion', document.getElementById('itemDescription').value);
            formData.append('precio', document.getElementById('itemPrice').value);
            if (imageInput.files[0]) {
                formData.append('imagen', imageInput.files[0]);
            }

            // Obtener el tipo seleccionado del dropdown
            const itemType = document.getElementById('itemType').value; // 'corte' o 'barba'
            
            // Determinar si estamos editando o creando nuevo
            const isBarba = itemType === 'barba' || editingBarbaId !== null;
            const editingItemId = isBarba ? editingBarbaId : editingId;
            const apiBase = isBarba ? '/api/barbas_admin' : '/api/cortes_admin';
            const url = editingItemId ? `${apiBase}/${editingItemId}` : apiBase;
            const method = editingItemId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, { method, body: formData });
                if (!response.ok) throw new Error('La operación falló.');
                
                alert(`${isBarba ? 'Barba' : 'Corte'} ${editingItemId ? 'actualizado' : 'registrado'} con éxito.`);
                itemForm.reset();
                imagePreview.src = '#';
                imagePreview.style.display = 'none';
                formButton.textContent = 'Guardar';
                editingId = null;
                editingBarbaId = null;
                itemForm.dataset.editingType = '';
                loadCortes();
                loadBarbas();
            } catch (error) {
                console.error(error);
                alert(`Error al guardar ${isBarba ? 'la barba' : 'el corte'}.`);
            }
        });

        function editItem(id) {
            const item = allCortes.find(c => c.id === id);
            if (item) {
                document.getElementById('itemType').value = 'corte'; // Establecer tipo como corte
                document.getElementById('itemName').value = item.nombre;
                document.getElementById('itemDescription').value = item.descripcion;
                document.getElementById('itemPrice').value = item.precio;
                imagePreview.src = item.imagen;
                imagePreview.style.display = 'block';
                
                formButton.textContent = 'Actualizar';
                editingId = id;
                editingBarbaId = null; // Asegurar que no esté editando barba
                window.scrollTo(0, 0);
            }
        }

        async function deleteItem(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar este corte?')) return;

            try {
                const response = await fetch(`/api/cortes_admin/${id}`, { method: 'DELETE' });
                const result = await response.json();
                alert(result.message);
                if (response.ok) {
                    loadCortes();
                }
            } catch (error) {
                console.error('Error al eliminar:', error);
                alert('Error al eliminar el corte.');
            }
        }

        // --- MODAL LOGIC ---
        function openConfigModal(id) {
            currentConfigId = id;
            currentConfigType = 'corte'; // Importante: marcar que estamos configurando un corte
            const corte = allCortes.find(c => c.id === id);

            if (corte) {
                // Llenar descripción principal
                document.getElementById('principalDescription').value = corte.descripcion_principal || '';
                
                // Llenar campos de destacado
                const destacadoDesc = document.getElementById('destacadoDescription');
                const destacadoImgPreview = document.getElementById('destacadoImagePreview');
                
                // Si el corte es principal y tiene descripcion_principal, prellenarla
                if (corte.rol === 'Principal' && corte.descripcion_principal) {
                    destacadoDesc.value = corte.descripcion_destacado || corte.descripcion_principal;
                } else {
                    destacadoDesc.value = corte.descripcion_destacado || '';
                }
                
                // Mostrar imagen destacado actual si existe
                if (corte.imagen_destacado) {
                    destacadoImgPreview.src = corte.imagen_destacado;
                    destacadoImgPreview.style.display = 'block';
                } else {
                    destacadoImgPreview.style.display = 'none';
                }
            }

            // Reset radio buttons to default
            configForm.configOption.value = 'principal';
            destacadoOptions.classList.add('hidden');
            principalOptions.classList.remove('hidden');

            modal.style.display = 'block';
        }

        closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target == modal) {
                modal.style.display = 'none';
            }
        });

        configForm.configOption.forEach(radio => {
            radio.addEventListener('change', function() {
                destacadoOptions.classList.toggle('hidden', this.value !== 'destacado');
                principalOptions.classList.toggle('hidden', this.value !== 'principal');
            });
        });

        configForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const option = this.configOption.value;
            const isBarba = currentConfigType === 'barba';
            const apiBase = isBarba ? '/api/barbas' : '/api/cortes';
            const allItems = isBarba ? allBarbas : allCortes;

            if (option === 'principal') {
                const descripcion_principal = document.getElementById('principalDescription').value;

                try {
                    const response = await fetch(`${apiBase}/principal/${currentConfigId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ descripcion_principal })
                    });

                    const result = await response.json();
                    alert(result.message);

                    if (response.ok) {
                        modal.style.display = 'none';
                        if (isBarba) {
                            loadBarbas();
                        } else {
                            loadCortes();
                        }
                    }
                } catch (error) {
                    console.error('Error al guardar la descripción principal:', error);
                    alert('Error al guardar.');
                }

            } else if (option === 'destacado') {
                const descripcion_destacado = document.getElementById('destacadoDescription').value;
                const imageFile = destacadoImageInput.files[0];
                const item = allItems.find(c => c.id === currentConfigId);

                // Crear FormData para enviar archivo e información
                const formData = new FormData();
                formData.append('descripcion_destacado', descripcion_destacado);
                
                // Si hay imagen nueva, agregarla
                if (imageFile) {
                    formData.append('imagen_destacado', imageFile);
                } else if (item && item.imagen_destacado) {
                    // Si no hay imagen nueva pero ya existe una, mantenerla
                    formData.append('imagen_destacado_existente', item.imagen_destacado);
                }

                try {
                    const response = await fetch(`${apiBase}/destacado/${currentConfigId}`, {
                        method: 'PUT',
                        body: formData
                    });

                    const result = await response.json();
                    alert(result.message);

                    if (response.ok) {
                        modal.style.display = 'none';
                        // Limpiar preview
                        destacadoImageNewPreview.src = '#';
                        destacadoImageNewPreview.style.display = 'none';
                        destacadoImageInput.value = '';
                        if (isBarba) {
                            loadBarbas();
                        } else {
                            loadCortes();
                        }
                    }
                } catch (error) {
                    console.error('Error al marcar como destacado:', error);
                    alert('Error al guardar como destacado.');
                }
            }
        });

        // --- FILTER LOGIC FOR TABLES ---
        const tableFilters = document.querySelectorAll('input[name="tableFilter"]');
        const cortesTable = document.getElementById('cortesTable');
        const barbasTable = document.getElementById('barbasTable');

        tableFilters.forEach(filter => {
            filter.addEventListener('change', function() {
                if (this.value === 'cortes') {
                    cortesTable.classList.remove('hidden');
                    barbasTable.classList.add('hidden');
                } else {
                    cortesTable.classList.add('hidden');
                    barbasTable.classList.remove('hidden');
                }
            });
        });

        // ==================== FUNCIONES CRUD PARA BARBAS ====================

        let editingBarbaId = null;
        let allBarbas = [];

        async function editBarba(id) {
            try {
                const response = await fetch('/api/barbas_admin');
                if (!response.ok) throw new Error('Error al cargar las barbas');
                allBarbas = await response.json();
                
                const barba = allBarbas.find(b => b.id === id);
                if (!barba) throw new Error('Barba no encontrada');
                
                editingBarbaId = id;
                editingId = null; // Asegurar que no esté editando corte
                document.getElementById('itemType').value = 'barba'; // Establecer tipo como barba
                document.getElementById('itemName').value = barba.nombre;
                document.getElementById('itemDescription').value = barba.descripcion;
                document.getElementById('itemPrice').value = barba.precio;
                
                imagePreview.src = barba.imagen;
                imagePreview.style.display = 'block';
                
                formButton.textContent = 'Actualizar';
                
                // Modificar temporalmente el formulario para editar barbas
                itemForm.dataset.editingType = 'barba';
                
                window.scrollTo(0, 0);
            } catch (error) {
                console.error(error);
                alert('No se pudo cargar la barba para editar.');
            }
        }

        async function deleteBarba(id) {
            if (!confirm('¿Estás seguro de eliminar esta barba?')) return;
            try {
                const response = await fetch(`/api/barbas_admin/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Error al eliminar la barba');
                alert('Barba eliminada correctamente');
                loadBarbas();
            } catch (error) {
                console.error(error);
                alert('No se pudo eliminar la barba.');
            }
        }

        async function openConfigModalBarba(id) {
            try {
                const response = await fetch('/api/barbas_admin');
                if (!response.ok) throw new Error('Error al cargar las barbas');
                allBarbas = await response.json();
                
                const barba = allBarbas.find(b => b.id === id);
                if (!barba) throw new Error('Barba no encontrada');
                
                currentConfigId = id;
                currentConfigType = 'barba'; // Importante: marcar que estamos configurando una barba
                
                // Llenar descripción principal
                document.getElementById('principalDescription').value = barba.descripcion_principal || '';
                
                // Llenar campos de destacado
                const destacadoDesc = document.getElementById('destacadoDescription');
                const destacadoImgPreview = document.getElementById('destacadoImagePreview');
                
                // Si la barba es principal y tiene descripcion_principal, prellenarla
                if (barba.rol === 'Principal' && barba.descripcion_principal) {
                    destacadoDesc.value = barba.descripcion_destacado || barba.descripcion_principal;
                } else {
                    destacadoDesc.value = barba.descripcion_destacado || '';
                }
                
                // Mostrar imagen destacado actual si existe
                if (barba.imagen_destacado) {
                    destacadoImgPreview.src = barba.imagen_destacado;
                    destacadoImgPreview.style.display = 'block';
                } else {
                    destacadoImgPreview.style.display = 'none';
                }
                
                // Reset radio buttons to default
                configForm.configOption.value = 'principal';
                destacadoOptions.classList.add('hidden');
                principalOptions.classList.remove('hidden');
                
                modal.style.display = 'block';
            } catch (error) {
                console.error(error);
                alert('No se pudo cargar la barba para configurar.');
            }
        }

        // ==================== FUNCIONES PARA MOVER ENTRE TABLAS ====================

        async function moverABarbas(corteId) {
            if (!confirm('¿Estás seguro de mover este corte a la tabla de Barbas?')) return;
            
            try {
                const response = await fetch(`/api/mover/corte-a-barba/${corteId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('✅ ' + result.message);
                    loadCortes();
                    loadBarbas();
                } else {
                    alert('❌ Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error al mover:', error);
                alert('❌ Error al mover el registro.');
            }
        }

        async function moverACortes(barbaId) {
            if (!confirm('¿Estás seguro de mover esta barba a la tabla de Cortes?')) return;
            
            try {
                const response = await fetch(`/api/mover/barba-a-corte/${barbaId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('✅ ' + result.message);
                    loadCortes();
                    loadBarbas();
                } else {
                    alert('❌ Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error al mover:', error);
                alert('❌ Error al mover el registro.');
            }
        }

    </script>

</body>
</html>