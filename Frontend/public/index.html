<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prestige Barbers</title>
    <link rel="stylesheet" href="I-style/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
</head>

<body>
    <header>
        <div class="head-logo-cont">
            <h1>Prestige Barbers</h1>
        </div>
        <div class="head-lkn-cont">
            <a href="">Shop</a>
            <a href="">Servicios</a>
            <a href="">Barberos</a>
            <a href="">Reservas</a>
            <a href="">Acerca De</a>
        </div>
    </header>

    <main>

        <div class="main-prin-cont">
            <div class="main-cut-imgs" id="carousel-container">
                <!-- Carousel content will be injected here -->
            </div>

            <div class="sub-main-cont">

                <div class="sub-main-cont-cut">
                    <div class="sub-main-cont-inf">
                        <h2>Cortes</h2>
                        <p>¡No necesitas filtro, lo que necesitas es un buen barbero!</p>
                        <a href="">Encuentra tu nuevo look</a>
                    </div>
                    <div class="sub-main-cont-img">
                        <img src="I-img/High-Fade-with-Longer-Buzz-Cut-and-Beard.jpg.webp" alt="High fade haircut">
                    </div>
                </div>

                <div class="sub-main-shop">
                    <div class="sub-main-shop-img">
                        <img src="I-img/Prospectors pomade.png" alt="Barber shop products">
                    </div>
                    <div class="sub-main-shop-inf">
                        <h2>Shop</h2>
                        <p>De rebelde a perfecto hazlo posible con nuestros productos</p>
                        <a href="">Encuentra el tuyo</a>
                    </div>
                </div>

            </div>
        </div>

        <div class="Svc-cont">
            <label for="">Explore Los Diversos Servicios Que Ofrecemos</label>
            <h2>Servicios</h2>
            <div class="Svc-cont-btn">
                <div class="Svc-btn-item">
                    <button id="btn-cabello"></button>
                    <label>Cabello</label>
                    <label>Desde 18.000$</label>
                </div>
                <div class="Svc-btn-item">
                    <button id="btn-barba"></button>
                    <label>Barba</label>
                    <label>Desde 18.000$</label>
                </div>
                <div class="Svc-btn-item">
                    <button id="btn-rostro"></button>
                    <label>Rostro</label>
                    <label>Incluido con el corte</label>
                </div>
                <div class="Svc-btn-item">
                    <button id="btn-tienda"></button>
                    <label>Cuidado personal</label>
                    <label>Explora la tienda.</label>
                </div>
            </div>
            <a href="">Descubrir Más</a>
        </div>
>        

        <div class="barb-cont">
            <div class="barb-cont-img-inf">
                <h2>Barberos</h2>
                <label for="">Conoce a tu nuevo barbero favorito.</label>
                <div class="barb-cont-lkns">
                    <a href="">Conoce los barberos</a>
                    <a href="">Explorar Los Cortes</a>
                </div>
            </div>
        </div>

        <div class="shop-cont">
            <label for="">De la barbería a tu rutina, el cuidado que mereces.</label>
            <h2>Shop</h2>
            <div class="shop-cont-btn">
                <div class="shop-btn-item">
                    <button id="btn-crema-skala"></button>
                    <label>crema skala</label>
                    <label>Desde 38.800$</label>
                </div>
                <div class="shop-btn-item">
                    <button id="btn-serum-natura"></button>
                    <label>serum Natura</label>
                    <label>Desde 38.800$</label>
                </div>
                <div class="shop-btn-item">
                    <button id="btn-shampoo-milagros"></button>
                    <label>Shampoo Milagros</label>
                    <label>Desde 38.800$</label>
                </div>
                <div class="shop-btn-item">
                    <button id="btn-tratamiento-caba"></button>
                    <label>Tratamiento capilar caba</label>
                    <label>Desde 38.800$</label>
                </div>
            </div>
            <a href="">Explorar tienda</a>
        </div>

        <div class="Ubic-cont">
            <div class="Ubic-cont-inf">
                <h2>Ubicacion</h2>
                <label>Puedes encontrarnos aqui</label>
                <div class="Ubic-cont-address">
                    <label>barrio falso</label>
                    <label>calle falsa #123</label>
                </div>
            </div>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            class Carousel {
                constructor(containerId) {
                    this.carouselContainer = document.getElementById(containerId);
                    if (!this.carouselContainer) {
                        console.error(`Carousel container with id ${containerId} not found.`);
                        return;
                    }

                    this.carouselTrack = document.createElement('div');
                    this.carouselTrack.className = 'carousel-track';
                    this.carouselContainer.appendChild(this.carouselTrack);

                    this.cuts = [];
                    this.slideCount = 0;
                    this.currentIndex = 1;
                    this.intervalId = null;
                    this.isDragging = false;
                    this.startX = 0;
                    this.currentTranslate = 0;
                    this.prevTranslate = 0;
                    this.animationID = 0;
                    this.isInitialLoad = true;
                    this.containerWidth = this.carouselContainer.getBoundingClientRect().width;
                    this.isTransitioning = false;

                    this.fetchCuts();
                    this.setupEventListeners();
                }

                fetchCuts() {
                    fetch('/api/cortes')
                        .then(response => response.json())
                        .then(data => {
                            this.cuts = data;
                            this.slideCount = this.cuts.length;
                            if (this.slideCount === 0) return;

                            this.createSlides();
                            this.createDots();
                            this.resizeCarousel();
                            this.updateDots();
                            this.resetInterval();

                            if (this.isInitialLoad) {
                                this.carouselContainer.style.opacity = 0;
                                setTimeout(() => {
                                    this.carouselContainer.style.opacity = 1;
                                }, 100);
                                this.isInitialLoad = false;
                            }
                        })
                        .catch(error => console.error('Error fetching cuts:', error));
                }

                createSlides() {
                    const slideElements = this.cuts.map((cut, index) => {
                        const slide = document.createElement('div');
                        slide.className = 'slide';
                        slide.innerHTML = `
                            <img src="${cut.image_url}" alt="${cut.name}">
                            <div class="main-cut-imgs-text">
                                <h2>Destacados de la semana</h2>
                                <h3>${cut.name}</h3>
                                <p>${cut.description}</p>
                                <a href="">Reserva Ahora</a>
                            </div>
                        `;
                        const text = slide.querySelector('.main-cut-imgs-text');
                        if (index !== 0) {
                            text.style.opacity = 0;
                        }
                        const link = slide.querySelector('a');
                        link.addEventListener('click', (e) => e.preventDefault());
                        return slide;
                    });

                    const firstClone = slideElements[0].cloneNode(true);
                    const lastClone = slideElements[this.slideCount - 1].cloneNode(true);

                    firstClone.querySelector('.main-cut-imgs-text').style.opacity = 0;
                    lastClone.querySelector('.main-cut-imgs-text').style.opacity = 0;

                    this.carouselTrack.appendChild(lastClone);
                    slideElements.forEach(slide => this.carouselTrack.appendChild(slide));
                    this.carouselTrack.appendChild(firstClone);

                    const allSlides = Array.from(this.carouselTrack.children);
                    const firstRealSlideText = allSlides[1]?.querySelector('.main-cut-imgs-text');
                    if (firstRealSlideText) firstRealSlideText.style.opacity = 1;
                }

                createDots() {
                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'carousel-dots';
                    this.carouselContainer.appendChild(dotsContainer);

                    this.cuts.forEach((_, index) => {
                        const dot = document.createElement('span');
                        dot.classList.add('dot');
                        dot.addEventListener('click', () => {
                            this.goToSlide(index + 1);
                        });
                        dotsContainer.appendChild(dot);
                    });
                }

                updateDots() {
                    const dots = this.carouselContainer.querySelectorAll('.dot');
                    let logicalIndex = this.currentIndex - 1;
                    if (this.currentIndex === 0) {
                        logicalIndex = this.slideCount - 1;
                    } else if (this.currentIndex === this.slideCount + 1) {
                        logicalIndex = 0;
                    }
                    dots.forEach((dot, index) => {
                        dot.classList.toggle('active', index === logicalIndex);
                    });
                }

                goToSlide(index) {
                    if (this.isTransitioning) return;

                    if (!this.isDragging && index === this.currentIndex) {
                        this.carouselTrack.style.transition = 'transform 0.5s ease-out';
                        this.setPositionByIndex();
                        return;
                    }

                    this.isTransitioning = true;
                    const slides = this.carouselTrack.querySelectorAll('.slide');
                    const currentText = slides[this.currentIndex]?.querySelector('.main-cut-imgs-text');
                    if (currentText) currentText.style.opacity = 0;

                    this.carouselTrack.style.transition = 'transform 0.5s ease-out';
                    this.currentIndex = index;
                    this.setPositionByIndex();
                    this.updateDots();
                    this.resetInterval();

                    setTimeout(() => {
                        const atLastClone = this.currentIndex === this.slideCount + 1;
                        const atFirstClone = this.currentIndex === 0;

                        if (atLastClone || atFirstClone) {
                            this.carouselTrack.style.transition = 'none';
                            this.currentIndex = atLastClone ? 1 : this.slideCount;
                            this.setPositionByIndex();
                        }

                        const newSlides = this.carouselTrack.querySelectorAll('.slide');
                        const newText = newSlides[this.currentIndex]?.querySelector('.main-cut-imgs-text');
                        if (newText) newText.style.opacity = 1;

                        this.isTransitioning = false;
                    }, 500);
                }

                nextSlide() {
                    this.goToSlide(this.currentIndex + 1);
                }

                resetInterval() {
                    clearInterval(this.intervalId);
                    this.intervalId = setInterval(() => this.nextSlide(), 5000);
                }

                resizeCarousel() {
                    this.containerWidth = this.carouselContainer.getBoundingClientRect().width;
                    this.carouselTrack.style.transition = 'none';
                    const allSlides = this.carouselTrack.querySelectorAll('.slide');
                    this.carouselTrack.style.width = `${allSlides.length * this.containerWidth}px`;
                    allSlides.forEach(slide => {
                        slide.style.width = `${this.containerWidth}px`;
                    });
                    this.setPositionByIndex();
                }

                setupEventListeners() {
                    window.addEventListener('resize', () => this.resizeCarousel());

                    this.carouselContainer.addEventListener('mousedown', (e) => this.dragStart(e));
                    this.carouselContainer.addEventListener('touchstart', (e) => this.dragStart(e));
                    this.carouselContainer.addEventListener('mousemove', (e) => this.dragMove(e));
                    this.carouselContainer.addEventListener('touchmove', (e) => this.dragMove(e));
                    this.carouselContainer.addEventListener('mouseup', () => this.dragEnd());
                    this.carouselContainer.addEventListener('mouseleave', () => this.dragEnd());
                    this.carouselContainer.addEventListener('touchend', () => this.dragEnd());
                }

                dragStart(event) {
                    if (this.isTransitioning) return;
                    this.isDragging = true;
                    this.startX = this.getPositionX(event);
                    this.animationID = requestAnimationFrame(() => this.animation());
                    this.carouselTrack.style.transition = 'none';
                    this.carouselContainer.classList.add('grabbing');
                }

                dragMove(event) {
                    if (this.isDragging) {
                        const currentPosition = this.getPositionX(event);
                        this.currentTranslate = this.prevTranslate + currentPosition - this.startX;
                    }
                }

                dragEnd() {
                    if (!this.isDragging) return;
                    this.isDragging = false;
                    cancelAnimationFrame(this.animationID);
                    this.carouselContainer.classList.remove('grabbing');

                    const movedBy = this.currentTranslate - this.prevTranslate;
                    if (movedBy < -50) {
                        this.goToSlide(this.currentIndex + 1);
                    } else if (movedBy > 50) {
                        this.goToSlide(this.currentIndex - 1);
                    } else {
                        this.goToSlide(this.currentIndex);
                    }
                }

                getPositionX(event) {
                    return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
                }

                animation() {
                    if (this.isDragging) {
                        this.setSliderPosition();
                        requestAnimationFrame(() => this.animation());
                    }
                }

                setSliderPosition() {
                    this.carouselTrack.style.transform = `translateX(${this.currentTranslate}px)`;
                }

                setPositionByIndex() {
                    this.currentTranslate = this.currentIndex * -this.containerWidth;
                    this.prevTranslate = this.currentTranslate;
                    this.carouselTrack.style.transform = `translateX(${this.currentTranslate}px)`;
                }
            }

            new Carousel('carousel-container');

            const header = document.querySelector('header');
            const sentinel = document.createElement('div');
            sentinel.style.position = 'absolute';
            sentinel.style.top = '0';
            sentinel.style.height = '1px';
            sentinel.style.width = '1px';
            document.body.prepend(sentinel);

            const observer = new IntersectionObserver(
                ([entry]) => {
                    header.classList.toggle('is-sticky', !entry.isIntersecting);
                },
                {
                    rootMargin: '-1px 0px 0px 0px',
                    threshold: 0
                }
            );

            observer.observe(sentinel);
        });
    </script>
</body>