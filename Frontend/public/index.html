<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prestige Barbers</title>
    <link rel="stylesheet" href="I-style/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
</head>

<body>
    <header>
        <div class="head-logo-cont">
            <h1>Prestige Barbers</h1>
        </div>
        <div class="head-lkn-cont">
            <a href="">Shop</a>
            <a href="">Servicios</a>
            <a href="">Barberos</a>
            <a href="">Reservas</a>
            <a href="">Acerca De</a>
        </div>
    </header>

    <main>

        <div class="main-prin-cont">
            <div class="main-cut-imgs" id="carousel-container">
                <!-- Carousel content will be injected here -->
            </div>

            <div class="sub-main-cont">

                <div class="sub-main-cont-cut">
                    <div class="sub-main-cont-inf">
                        <h2>Cortes</h2>
                        <p>¡No necesitas filtro, lo que necesitas es un buen barbero!</p>
                        <a href="">Encuentra tu nuevo look</a>
                    </div>
                    <div class="sub-main-cont-img">
                        <img src="I-img/High-Fade-with-Longer-Buzz-Cut-and-Beard.jpg.webp" alt="High fade haircut">
                    </div>
                </div>

                <div class="sub-main-shop">
                    <div class="sub-main-shop-img">
                        <img src="I-img/Prospectors pomade.png" alt="Barber shop products">
                    </div>
                    <div class="sub-main-shop-inf">
                        <h2>Shop</h2>
                        <p>De rebelde a perfecto hazlo posible con nuestros productos</p>
                        <a href="">Encuentra el tuyo</a>
                    </div>
                </div>

            </div>
        </div>

        <div class="Svc-cont">
            <label for="">Explore Los Diversos Servicios Que Ofrecemos</label>
            <h2>Servicios</h2>
            <div class="Svc-cont-btn">
                <div class="Svc-btn-item">
                    <button id="btn-cabello"></button>
                    <label>Cabello</label>
                    <label>Desde 18.000$</label>
                </div>
                <div class="Svc-btn-item">
                    <button id="btn-barba"></button>
                    <label>Barba</label>
                    <label>Desde 18.000$</label>
                </div>
                <div class="Svc-btn-item">
                    <button id="btn-rostro"></button>
                    <label>Rostro</label>
                    <label>Incluido con el corte</label>
                </div>
                <div class="Svc-btn-item">
                    <button id="btn-tienda"></button>
                    <label>Cuidado personal</label>
                    <label>Explora la tienda.</label>
                </div>
            </div>
            <a href="">Descubrir Más</a>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const carouselContainer = document.getElementById('carousel-container');
            const carouselTrack = document.createElement('div');
            carouselTrack.className = 'carousel-track';
            carouselContainer.appendChild(carouselTrack);

            let cuts = [];
            let slideCount = 0;
            let currentIndex = 1; // Start at 1, the first "real" slide
            let intervalId = null;
            let isDragging = false;
            let startX = 0;
            let currentTranslate = 0;
            let prevTranslate = 0;
            let animationID = 0;
            let isInitialLoad = true;
            let containerWidth = carouselContainer.offsetWidth;
            let isTransitioning = false;

            function setPositionByIndex() {
                currentTranslate = currentIndex * -containerWidth;
                prevTranslate = currentTranslate;
                carouselTrack.style.transform = `translateX(${currentTranslate}px)`;
            }

            // The transitionend event can be unreliable. A timeout matching the CSS transition is more robust.
            // The handleTransitionEnd function and its listener are removed and replaced by this new goToSlide logic.
            function goToSlide(index) {
                if (isTransitioning) return;

                // This handles the snap-back case in dragEnd where the drag distance is not enough to change slide.
                if (!isDragging && index === currentIndex) {
                    carouselTrack.style.transition = 'transform 0.5s ease-out';
                    setPositionByIndex();
                    return;
                }

                isTransitioning = true;
                const slides = carouselTrack.querySelectorAll('.slide');
                const currentText = slides[currentIndex]?.querySelector('.main-cut-imgs-text');
                if (currentText) currentText.style.opacity = 0;

                carouselTrack.style.transition = 'transform 0.5s ease-out';
                currentIndex = index;
                setPositionByIndex();
                updateDots();
                resetInterval();

                setTimeout(() => {
                    const atLastClone = currentIndex === slideCount + 1;
                    const atFirstClone = currentIndex === 0;

                    if (atLastClone || atFirstClone) {
                        // We've finished sliding to a clone. Now, perform an instant "jump"
                        // to the corresponding real slide by disabling the transition.
                        carouselTrack.style.transition = 'none';
                        currentIndex = atLastClone ? 1 : slideCount;
                        setPositionByIndex();
                    }
                    
                    // Fade in the text of the new current slide (works for both regular slides and after a jump).
                    const newSlides = carouselTrack.querySelectorAll('.slide');
                    const newText = newSlides[currentIndex]?.querySelector('.main-cut-imgs-text');
                    if (newText) newText.style.opacity = 1;

                    // The entire transition/jump sequence is complete, so we can allow the next one.
                    isTransitioning = false;
                }, 500); // IMPORTANT: This duration must match the 'transform' transition duration in milliseconds.
            }

            function createDots() {
                const dotsContainer = document.createElement('div');
                dotsContainer.className = 'carousel-dots';
                carouselContainer.appendChild(dotsContainer);

                cuts.forEach((_, index) => {
                    const dot = document.createElement('span');
                    dot.classList.add('dot');
                    dot.addEventListener('click', () => {
                        goToSlide(index + 1);
                    });
                    dotsContainer.appendChild(dot);
                });
            }

            function updateDots() {
                const dots = carouselContainer.querySelectorAll('.dot');
                let logicalIndex = currentIndex - 1;
                if (currentIndex === 0) {
                    logicalIndex = slideCount - 1;
                } else if (currentIndex === slideCount + 1) {
                    logicalIndex = 0;
                }
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === logicalIndex);
                });
            }

            function nextSlide() {
                goToSlide(currentIndex + 1);
            }

            function resetInterval() {
                clearInterval(intervalId);
                intervalId = setInterval(nextSlide, 5000);
            }

            function resizeCarousel() {
                containerWidth = carouselContainer.offsetWidth;
                carouselTrack.style.transition = 'none';
                const allSlides = carouselTrack.querySelectorAll('.slide');
                carouselTrack.style.width = `${allSlides.length * containerWidth}px`;
                allSlides.forEach(slide => {
                    slide.style.width = `${containerWidth}px`;
                });
                setPositionByIndex();
            }

            window.addEventListener('resize', resizeCarousel);

            carouselContainer.addEventListener('mousedown', dragStart);
            carouselContainer.addEventListener('touchstart', dragStart);
            carouselContainer.addEventListener('mousemove', dragMove);
            carouselContainer.addEventListener('touchmove', dragMove);
            carouselContainer.addEventListener('mouseup', dragEnd);
            carouselContainer.addEventListener('mouseleave', dragEnd);
            carouselContainer.addEventListener('touchend', dragEnd);

            function dragStart(event) {
                if (isTransitioning) return;
                isDragging = true;
                startX = getPositionX(event);
                animationID = requestAnimationFrame(animation);
                carouselTrack.style.transition = 'none';
                carouselContainer.classList.add('grabbing');
            }

            function dragMove(event) {
                if (isDragging) {
                    const currentPosition = getPositionX(event);
                    currentTranslate = prevTranslate + currentPosition - startX;
                }
            }

            function dragEnd(event) {
                if (!isDragging) return;
                isDragging = false;
                cancelAnimationFrame(animationID);
                carouselContainer.classList.remove('grabbing');

                const movedBy = currentTranslate - prevTranslate;
                if (movedBy < -50) {
                    goToSlide(currentIndex + 1);
                } else if (movedBy > 50) {
                    goToSlide(currentIndex - 1);
                } else {
                    goToSlide(currentIndex); // Snap back
                }
            }

            function getPositionX(event) {
                return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
            }

            function animation() {
                if (isDragging) {
                    setSliderPosition();
                    requestAnimationFrame(animation);
                }
            }

            function setSliderPosition() {
                carouselTrack.style.transform = `translateX(${currentTranslate}px)`;
            }

            fetch('/api/cortes')
                .then(response => response.json())
                .then(data => {
                    cuts = data;
                    slideCount = cuts.length;
                    if (slideCount === 0) return;

                    const slideElements = cuts.map((cut, index) => {
                        const slide = document.createElement('div');
                        slide.className = 'slide';
                        slide.innerHTML = `
                            <img src="${cut.image_url}" alt="${cut.name}">
                            <div class="main-cut-imgs-text">
                                <h2>Destacados de la semana</h2>
                                <h3>${cut.name}</h3>
                                <p>${cut.description}</p>
                                <a href="">Reserva Ahora</a>
                            </div>
                        `;
                        const text = slide.querySelector('.main-cut-imgs-text');
                        if (index !== 0) {
                            text.style.opacity = 0;
                        }
                        const link = slide.querySelector('a');
                        link.addEventListener('click', (e) => e.preventDefault());
                        return slide;
                    });

                    const firstClone = slideElements[0].cloneNode(true);
                    const lastClone = slideElements[slideCount - 1].cloneNode(true);

                    // Ensure text on clones is not visible to prevent flickering during loop
                    firstClone.querySelector('.main-cut-imgs-text').style.opacity = 0;
                    lastClone.querySelector('.main-cut-imgs-text').style.opacity = 0;

                    carouselTrack.appendChild(lastClone);
                    slideElements.forEach(slide => carouselTrack.appendChild(slide));
                    carouselTrack.appendChild(firstClone);

                    // Must update slides to include clones for text fading
                    const allSlides = Array.from(carouselTrack.children);
                    const firstRealSlideText = allSlides[1]?.querySelector('.main-cut-imgs-text');
                    if (firstRealSlideText) firstRealSlideText.style.opacity = 1;


                    createDots();
                    resizeCarousel();
                    updateDots();
                    resetInterval();

                    if (isInitialLoad) {
                        carouselContainer.style.opacity = 0;
                        setTimeout(() => {
                            carouselContainer.style.opacity = 1;
                        }, 100);
                        isInitialLoad = false;
                    }
                })
                .catch(error => console.error('Error fetching cuts:', error));
        });
    </script>

</body>