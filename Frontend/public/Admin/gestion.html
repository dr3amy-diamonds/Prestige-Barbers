<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Gestión - Prestige Barbers</title>
    <link rel="stylesheet" href="gestion-styles.css">
</head>
<body>

    <header class="page-header">
        <h1>Panel de Gestión</h1>
        <a href="index.html" class="back-link">Volver al Inicio</a>
    </header>

    <main class="management-grid">
        <!-- Card para Cortes de Pelo -->
        <div class="card">
            <div class="card-header">
                <h2>Relación Cortes de Pelo</h2>
                <p>Administra los cortes de pelo principales y sus relaciones.</p>
            </div>
            <div class="card-body" id="cortesRelacionesContainer">
                <!-- Los cortes principales se cargarán dinámicamente aquí -->
                <p style="text-align: center; color: #666;">Cargando cortes principales...</p>
            </div>
        </div>

        <!-- Card para Cortes de Barba -->
        <div class="card">
            <div class="card-header">
                <h2>Relación Cortes de Barba</h2>
                <p>Administra los estilos de barba y sus variaciones.</p>
            </div>
            <div class="card-body" id="barbasRelacionesContainer">
                <!-- Las barbas principales se cargarán dinámicamente aquí -->
                <p style="text-align: center; color: #666;">Cargando barbas principales...</p>
            </div>
        </div>

        <!-- Card para Descripciones de Cortes Principales -->
        <div class="card">
            <div class="card-header">
                <h2>Descripciones de Cortes Principales</h2>
                <p>Edita el texto descriptivo de cada corte principal.</p>
            </div>
            <div class="card-body">
                <form class="description-form">
                    <h4>Selecciona el corte</h4>
                    <select id="edit-desc-select">
                        <option value="buzz">Buzz Cut</option>
                        <option value="low-taper">Low Taper Fade</option>
                        <option value="fade-bear">Fade Bear (Barba)</option>
                        <option value="goatee">Goatee (Barba)</option>
                    </select>
                    <h4>Descripción</h4>
                    <textarea id="edit-desc-textarea" rows="6" placeholder="La descripción del corte aparecerá aquí..."></textarea>
                    <button type="submit">Guardar Descripción</button>
                </form>
            </div>
        </div>

        <!-- Card para Cortes Destacados -->
        <div class="card">
            <div class="card-header">
                <h2>Cortes Destacados</h2>
                <p>Administra las imágenes y descripciones de los cortes mostrados en la página principal.</p>
            </div>
            <div class="card-body">
                <form class="featured-form">
                    <h4>Selecciona el corte destacado</h4>
                    <select id="edit-featured-select">
                        <option value="destacado1">Destacado 1 (Buzz Cut)</option>
                        <option value="destacado2">Destacado 2 (Low Taper Fade)</option>
                        <option value="destacado3">Destacado 3 (Fade Bear)</option>
                    </select>
                    <h4>Descripción</h4>
                    <textarea id="edit-featured-textarea" rows="4" placeholder="Descripción para la sección de destacados..."></textarea>
                    <h4>Cambiar Imagen</h4>
                    <input type="file" id="edit-featured-image">
                    <img id="featured-image-preview" class="image-preview" src="#" alt="Previsualización" style="display: none;">
                    <button type="submit">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </main>

    <script>
        let cortesDisponibles = []; // Cache de cortes disponibles
        let cortesPrincipales = []; // Cache de cortes principales
        let barbasDisponibles = []; // Cache de barbas disponibles
        let barbasPrincipales = []; // Cache de barbas principales

        // Cargar todo al inicio
        document.addEventListener('DOMContentLoaded', async () => {
            await cargarCortesPrincipales();
            await cargarBarbasPrincipales();
        });

        // Función para cargar los cortes principales y sus relaciones
        async function cargarCortesPrincipales() {
            try {
                const response = await fetch('/api/cortes/principales');
                if (!response.ok) throw new Error('Error al cargar cortes principales');
                
                cortesPrincipales = await response.json();
                const container = document.getElementById('cortesRelacionesContainer');
                
                if (cortesPrincipales.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999;">No hay cortes designados como principales aún.</p>';
                    return;
                }

                container.innerHTML = ''; // Limpiar contenedor

                // Crear un formulario para cada corte principal
                for (const principal of cortesPrincipales) {
                    const relacionados = await cargarRelacionados(principal.id);
                    const disponibles = await cargarDisponibles(principal.id);
                    
                    const div = crearFormularioPrincipal(principal, relacionados, disponibles);
                    container.appendChild(div);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('cortesRelacionesContainer').innerHTML = 
                    '<p style="text-align: center; color: red;">Error al cargar los cortes principales.</p>';
            }
        }

        // Función para cargar los cortes relacionados a un principal
        async function cargarRelacionados(principalId) {
            try {
                const response = await fetch(`/api/cortes/relacionados/${principalId}`);
                if (!response.ok) throw new Error('Error al cargar relacionados');
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                return [];
            }
        }

        // Función para cargar cortes disponibles para relacionar
        async function cargarDisponibles(principalId) {
            try {
                const response = await fetch(`/api/cortes/disponibles/${principalId}`);
                if (!response.ok) throw new Error('Error al cargar disponibles');
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                return [];
            }
        }

        // Crear el HTML para cada corte principal
        function crearFormularioPrincipal(principal, relacionados, disponibles) {
            const div = document.createElement('div');
            div.className = 'principal-cut-container';
            
            const relacionadosIds = relacionados.map(r => r.id);
            
            div.innerHTML = `
                <h4>Corte Principal: ${principal.nombre}</h4>
                <img src="${principal.imagen}" alt="${principal.nombre}" style="max-width: 150px; border-radius: 8px;">
                <p style="font-size: 14px; color: #666; margin: 10px 0;">${principal.descripcion_principal || 'Sin descripción principal'}</p>
                <form class="relations-form" data-principal-id="${principal.id}">
                    <div class="selectors-container">
                        ${crearSelectores(disponibles, relacionadosIds)}
                    </div>
                    <button type="submit">Guardar Relaciones</button>
                </form>
            `;

            // Agregar evento de submit
            const form = div.querySelector('.relations-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await guardarRelaciones(principal.id, form);
            });

            return div;
        }

        // Crear los 4 selectores con las opciones
        function crearSelectores(disponibles, relacionadosIds) {
            let html = '';
            for (let i = 0; i < 4; i++) {
                const selectedId = relacionadosIds[i] || '';
                html += `
                    <select name="relacionado${i + 1}">
                        <option value="">-- Seleccionar Relacionado ${i + 1} --</option>
                        ${disponibles.map(corte => `
                            <option value="${corte.id}" ${corte.id === selectedId ? 'selected' : ''}>
                                ${corte.nombre} ${corte.corte_principal_id ? '(Ya asignado)' : ''}
                            </option>
                        `).join('')}
                    </select>
                `;
            }
            return html;
        }

        // Guardar las relaciones
        async function guardarRelaciones(principalId, form) {
            const formData = new FormData(form);
            const relacionados = [];

            // Recoger los IDs seleccionados (excluyendo vacíos)
            for (let i = 1; i <= 4; i++) {
                const value = formData.get(`relacionado${i}`);
                if (value) {
                    relacionados.push(parseInt(value));
                }
            }

            try {
                const response = await fetch(`/api/cortes/relacionar/${principalId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ relacionados })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ ${result.message}\n${result.affectedRows} corte(s) relacionado(s) actualizados.`);
                    await cargarCortesPrincipales(); // Recargar todo
                } else {
                    alert(`❌ Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error al guardar relaciones:', error);
                alert('❌ Error al guardar las relaciones.');
            }
        }

        // Scripts antiguos simplificados
        document.querySelector('.description-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Funcionalidad de descripción en desarrollo.');
        });

        document.querySelector('.featured-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Funcionalidad de destacados en desarrollo.');
        });

        // Preview para la imagen de destacados
        const featuredImageInput = document.getElementById('edit-featured-image');
        const featuredImagePreview = document.getElementById('featured-image-preview');
        if (featuredImageInput) {
            featuredImageInput.addEventListener('change', () => {
                const file = featuredImageInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        featuredImagePreview.src = e.target.result;
                        featuredImagePreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        // ==================== FUNCIONES PARA BARBAS ====================

        // Función para cargar las barbas principales y sus relaciones
        async function cargarBarbasPrincipales() {
            try {
                const response = await fetch('/api/barbas/principales');
                if (!response.ok) throw new Error('Error al cargar barbas principales');
                
                barbasPrincipales = await response.json();
                const container = document.getElementById('barbasRelacionesContainer');
                
                if (barbasPrincipales.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999;">No hay barbas designadas como principales aún.</p>';
                    return;
                }

                container.innerHTML = ''; // Limpiar contenedor

                // Crear un formulario para cada barba principal
                for (const principal of barbasPrincipales) {
                    const relacionados = await cargarBarbasRelacionadas(principal.id);
                    const disponibles = await cargarBarbasDisponibles(principal.id);
                    
                    const div = crearFormularioBarba(principal, relacionados, disponibles);
                    container.appendChild(div);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('barbasRelacionesContainer').innerHTML = 
                    '<p style="text-align: center; color: red;">Error al cargar las barbas principales.</p>';
            }
        }

        // Función para cargar las barbas relacionadas a una principal
        async function cargarBarbasRelacionadas(principalId) {
            try {
                const response = await fetch(`/api/barbas/relacionados/${principalId}`);
                if (!response.ok) throw new Error('Error al cargar relacionadas');
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                return [];
            }
        }

        // Función para cargar barbas disponibles para relacionar
        async function cargarBarbasDisponibles(principalId) {
            try {
                const response = await fetch(`/api/barbas/disponibles/${principalId}`);
                if (!response.ok) throw new Error('Error al cargar disponibles');
                return await response.json();
            } catch (error) {
                console.error('Error:', error);
                return [];
            }
        }

        // Crear el HTML para cada barba principal
        function crearFormularioBarba(principal, relacionados, disponibles) {
            const div = document.createElement('div');
            div.className = 'principal-cut-container';
            
            const relacionadosIds = relacionados.map(r => r.id);
            
            div.innerHTML = `
                <h4>Barba Principal: ${principal.nombre}</h4>
                <img src="${principal.imagen}" alt="${principal.nombre}" style="max-width: 150px; border-radius: 8px;">
                <p style="font-size: 14px; color: #666; margin: 10px 0;">${principal.descripcion_principal || 'Sin descripción principal'}</p>
                <form class="relations-form" data-principal-id="${principal.id}">
                    <div class="selectors-container">
                        ${crearSelectoresBarbas(disponibles, relacionadosIds)}
                    </div>
                    <button type="submit">Guardar Relaciones</button>
                </form>
            `;

            // Agregar evento de submit
            const form = div.querySelector('.relations-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await guardarRelacionesBarbas(principal.id, form);
            });

            return div;
        }

        // Crear los 4 selectores con las opciones para barbas
        function crearSelectoresBarbas(disponibles, relacionadosIds) {
            let html = '';
            for (let i = 0; i < 4; i++) {
                const selectedId = relacionadosIds[i] || '';
                html += `
                    <select name="relacionado${i + 1}">
                        <option value="">-- Ninguno --</option>
                        ${disponibles.map(barba => `
                            <option value="${barba.id}" ${barba.id == selectedId ? 'selected' : ''}>
                                ${barba.nombre} ${barba.barba_principal_id ? '(Ya asignado)' : ''}
                            </option>
                        `).join('')}
                    </select>
                `;
            }
            return html;
        }

        // Guardar las relaciones de barbas
        async function guardarRelacionesBarbas(principalId, form) {
            const formData = new FormData(form);
            const relacionados = [];

            // Recoger los IDs seleccionados (excluyendo vacíos)
            for (let i = 1; i <= 4; i++) {
                const value = formData.get(`relacionado${i}`);
                if (value) {
                    relacionados.push(parseInt(value));
                }
            }

            try {
                const response = await fetch(`/api/barbas/relacionar/${principalId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ relacionados })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert(`✅ ${result.message}\n${result.affectedRows} barba(s) relacionada(s) actualizada(s).`);
                    await cargarBarbasPrincipales(); // Recargar todo
                } else {
                    alert(`❌ Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error al guardar relaciones:', error);
                alert('❌ Error al guardar las relaciones.');
            }
        }
    </script>

</body>
</html>